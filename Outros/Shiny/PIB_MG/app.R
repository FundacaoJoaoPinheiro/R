#
# This is a Shiny web application. You can run the application by clicking
# the 'Run App' button above.
#
# Find out more about building applications with Shiny here:
#
#    http://shiny.rstudio.com/
#

library(shiny)
library(shinydashboard)
library("readxl")
library("dplyr")
library(highcharter)
library(tidyverse)
library("xlsx")
library("shinyjs")
library(shinyBS)
library(rvest)

#dir <- dirname(rstudioapi::getActiveDocumentContext()$path)
#setwd(dir)


# Importação dos dados e pré-processamento ------------------------------------------------------------------------------

temp = tempfile(fileext = ".xlsx")
pag_fjp <- read_html("http://fjp.mg.gov.br/produto-interno-bruto-pib-de-minas-gerais/")
url <- pag_fjp |> html_element(xpath = "//a[contains(text(), 'Base')]/../../../*/div[@id='elementor-tab-content-1429']/*/li[2]/a") |> html_attr(name = 'href')
download.file(url, destfile=temp, mode='wb')
#file_tab1 <- read.xlsx(temp, sheet= 1)
file_tab1 <- read.xlsx(temp, sheetIndex = 1)
file_tab4 <- read.xlsx(temp, sheetIndex = 4)
file_tab5 <- read.xlsx(temp, sheetIndex = 5)
file_tab6 <- read.xlsx(temp, sheetIndex = 6)
file_tab7 <- read.xlsx(temp, sheetIndex = 7)
file_tab8 <- read.xlsx(temp, sheetIndex = 8)
file_tab10 <- read.xlsx(temp, sheetIndex = 10)

#file_tab1 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 1)
#file_tab4 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 4)
#file_tab5 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 5)
#file_tab6 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 6)
#file_tab7 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 7)
#file_tab8 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 8)
#file_tab10 <- read.xlsx("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx", sheetIndex = 10)


ultimo_ano <- file_tab1[4, ]
ultimo_ano <- as.numeric(max(ultimo_ano[!is.na(ultimo_ano)]))

contas_economicas <- file_tab1[c(7,8,10,17,18,19,20,21,11), c(1:(ultimo_ano-2010+2))]
nomes <- c("Produção", "Impostos produtos", "Consumo Intermediário", "Remuneração", "Salários", "Contribuições", "Impostos produção", "Excedente", "PIB")
nomes_producao <- c("Produção", "Impostos produtos", "Consumo Intermediário", "PIB")
nomes_renda <- c("Remuneração", "Salários", "Contribuições", "Impostos produção", "Excedente", "PIB")
contas_economicas[, 1] <-  nomes
colnames(contas_economicas)[c(1:(ultimo_ano-2010+2))] <- c("contas", as.character(c(2010:ultimo_ano)))
contas_economicas <- contas_economicas %>% gather(key = 'ano', value = 'valor', -contas)
contas_economicas[, -1] <- lapply(contas_economicas[, -1], as.numeric) # make all columns numeric


pib_percapita <- file_tab4[c(5,9,12), c(1:(ultimo_ano-2010+2))]
nomes <- c("PIB", "População", "PIB per capita")
pib_percapita[, 1] <-  nomes
colnames(pib_percapita)[c(1:(ultimo_ano-2010+2))] <- c("especificacao", as.character(c(2010:ultimo_ano)))
pib_percapita <- pib_percapita %>% gather(key = 'ano', value = 'valor', -especificacao)
pib_percapita[, -1] <- lapply(pib_percapita[, -1], as.numeric) # make all columns numeric

vbp_corrente <- file_tab5[c(7:27), c(1, seq(2, length=(ultimo_ano-2010+1), by=4))] 
vbp_var_volume <- file_tab5[c(7:27), c(1, seq(3, length=(ultimo_ano-2010), by=4))] 
vbp_var_preco <- file_tab5[c(7:27), c(1, seq(5, length=(ultimo_ano-2010), by=4))]
vbp_particip <- file_tab8[c(6:26), c(1:(ultimo_ano-2010+2))]
setores <- c("Agropecuária",
           "Agricultura",
           "Pecuária",
           "Prod. florestal",
           "Indústria",
           "Ind. extrativa",
           "Ind. transformação",
           "Energia e saneamento",
           "Construção",
           "Serviços",
           "Comércio",
           "Transporte",
           "Alojamento e alimentação",
           "Informação e comunicação",
           "Ativ. financeiras",
           "Ativ. imobiliárias",
           "Serv. pres. empresas",
           "APU",
           "Educação e saúde",
           "Cultura e esporte",
           "Serv. domésticos"
)
setor_index <- c(2:4, 6:9, 11:21)
area_index <- c(1, 5, 10)
setor <- setores[setor_index]
area <- setores[area_index]

espec_prod <- c('Produção', 'Impostos produtos', 'Consumo Intermediário', 'PIB')
espec_renda <- c('Salários', 'Contribuições', 'Impostos produção', 'Excedente', 'PIB')
tipoResutados <- c("Valor Bruto da Produção" = 'VBP', "Consumo Intermediário" = 'CI', "Valor Adicionado Bruto" = 'VAB')
aspectos2 <- c("Valor corrente" = 'vc', "Var. volume" = 'vv', "Var. preço" = 'vp', "Part. valor corrente em MG" = 'pmg' , "Part. valor corrente no Brasil" = 'pbr')
tiposGraficos <- c("Linha" = 'linha', "Barra"= 'barra', "Barra Empilhado" = 'barra_empilhado', "Pizza" = 'pizza')
tiposGraficos2 <- c("Linha" = 'linha', "Barra"= 'barra')
vbp_corrente[, 1] <-  setores
colnames(vbp_corrente)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
vbp_corrente <- vbp_corrente %>% gather(key = 'ano', value = 'valor', -setor)
vbp_corrente[, -1] <- lapply(vbp_corrente[, -1], as.numeric) # make all columns numeric

vbp_var_volume[, 1] <-  setores
colnames(vbp_var_volume)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
vbp_var_volume <- vbp_var_volume %>% gather(key = 'ano', value = 'valor', -setor)
vbp_var_volume[, -1] <- lapply(vbp_var_volume[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
vbp_var_volume <- rbind(aux, vbp_var_volume)

vbp_var_preco[, 1] <-  setores
colnames(vbp_var_preco)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
vbp_var_preco <- vbp_var_preco %>% gather(key = 'ano', value = 'valor', -setor)
vbp_var_preco[, -1] <- lapply(vbp_var_preco[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
vbp_var_preco <- rbind(aux, vbp_var_preco)

vbp_particip[, 1] <-  setores
colnames(vbp_particip)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
vbp_particip <- vbp_particip %>% gather(key = 'ano', value = 'valor', -setor)
vbp_particip[, -1] <- lapply(vbp_particip[, -1], as.numeric) # make all columns numeric

vbp <- cbind(vbp_corrente, vbp_var_volume[3], vbp_var_preco[3],  vbp_particip[, 3])
colnames(vbp) <- c("setor", "ano", "corrente", "var_volume", "var_preco", "particip")


ci_corrente <- file_tab6[c(7:27), c(1, seq(2, length=(ultimo_ano-2010+1), by=4))]
ci_var_volume <- file_tab6[c(7:27), c(1, seq(3, length=(ultimo_ano-2010), by=4))]
ci_var_preco <- file_tab6[c(7:27), c(1, seq(5, length=(ultimo_ano-2010), by=4))]
ci_particip <- file_tab8[c(6:26), c(1, seq((ultimo_ano-2010+3), length=(ultimo_ano-2010+1), by=1))]

ci_corrente[, 1] <-  setores
colnames(ci_corrente)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
ci_corrente <- ci_corrente %>% gather(key = 'ano', value = 'valor', -setor)
ci_corrente[, -1] <- lapply(ci_corrente[, -1], as.numeric) # make all columns numeric

ci_var_volume[, 1] <-  setores
colnames(ci_var_volume)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
ci_var_volume <- ci_var_volume %>% gather(key = 'ano', value = 'valor', -setor)
ci_var_volume[, -1] <- lapply(ci_var_volume[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
ci_var_volume <- rbind(aux, ci_var_volume)

ci_var_preco[, 1] <-  setores
colnames(ci_var_preco)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
ci_var_preco <- ci_var_preco %>% gather(key = 'ano', value = 'valor', -setor)
ci_var_preco[, -1] <- lapply(ci_var_preco[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
ci_var_preco <- rbind(aux, ci_var_preco)

ci_particip[, 1] <-  setores
colnames(ci_particip)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
ci_particip <- ci_particip %>% gather(key = 'ano', value = 'valor', -setor)
ci_particip[, -1] <- lapply(ci_particip[, -1], as.numeric) # make all columns numeric

ci <- cbind(ci_corrente, ci_var_volume[3], ci_var_preco[3],  ci_particip[, 3])
colnames(ci) <- c("setor", "ano", "corrente", "var_volume", "var_preco", "particip")


vab_corrente <- file_tab7[c(7:27), c(1, seq(2, length=(ultimo_ano-2010+1), by=4))]
vab_var_volume <- file_tab7[c(7:27), c(1, seq(3, length=(ultimo_ano-2010), by=4))]
vab_var_preco <- file_tab7[c(7:27), c(1, seq(5, length=(ultimo_ano-2010), by=4))]
vab_particip <- file_tab8[c(6:26), c(1, seq((ultimo_ano-2010+2)*2, length=(ultimo_ano-2010+1), by=1))]
vab_particip_br <- file_tab10[c(6:26), c(1:(ultimo_ano-2010+2))]

vab_corrente[, 1] <-  setores
colnames(vab_corrente)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
vab_corrente <- vab_corrente %>% gather(key = 'ano', value = 'valor', -setor)
vab_corrente[, -1] <- lapply(vab_corrente[, -1], as.numeric) # make all columns numeric

vab_var_volume[, 1] <-  setores
colnames(vab_var_volume)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
vab_var_volume <- vab_var_volume %>% gather(key = 'ano', value = 'valor', -setor)
vab_var_volume[, -1] <- lapply(vab_var_volume[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
vab_var_volume <- rbind(aux, vab_var_volume)

vab_var_preco[, 1] <-  setores
colnames(vab_var_preco)[c(1:(ultimo_ano-2010+1))] <- c("setor", as.character(c(2011:ultimo_ano)))
vab_var_preco <- vab_var_preco %>% gather(key = 'ano', value = 'valor', -setor)
vab_var_preco[, -1] <- lapply(vab_var_preco[, -1], as.numeric) # make all columns numeric
aux <- data.frame(setores, 2010, NA)
names(aux) <- c("setor", "ano", "valor")
vab_var_preco <- rbind(aux, vab_var_preco)

vab_particip[, 1] <-  setores
colnames(vab_particip)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
vab_particip <- vab_particip %>% gather(key = 'ano', value = 'valor', -setor)
vab_particip[, -1] <- lapply(vab_particip[, -1], as.numeric) # make all columns numeric

vab_particip_br[, 1] <-  setores
colnames(vab_particip_br)[c(1:(ultimo_ano-2010+2))] <- c("setor", as.character(c(2010:ultimo_ano)))
vab_particip_br <- vab_particip_br %>% gather(key = 'ano', value = 'valor', -setor)
vab_particip_br[, -1] <- lapply(vab_particip_br[, -1], as.numeric) # make all columns numeric

vab <- cbind(vab_corrente, vab_var_volume[3], vab_var_preco[3],  vab_particip[3], vab_particip_br[3] )
colnames(vab) <- c("setor", "ano", "corrente", "var_volume", "var_preco", "particip", "particip_br")

valor_corrente <- cbind(vbp_corrente, ci_corrente[3], vab_corrente[3])
colnames(valor_corrente) <- c("setor", "ano", "VBP", "CI", "VAB")
valor_corrente <- pivot_longer(valor_corrente, cols = c(3:5), names_to = "resultado", values_to = "valor")

var_volume <- cbind(vbp_var_volume, ci_var_volume[3], vab_var_volume[3])
colnames(var_volume) <- c("setor", "ano", "VBP", "CI", "VAB")
var_volume <- pivot_longer(var_volume, cols = c(3:5), names_to = "resultado", values_to = "valor")

var_preco <- cbind(vbp_var_preco, ci_var_preco[3], vab_var_preco[3])
colnames(var_preco) <- c("setor", "ano", "VBP", "CI", "VAB")
var_preco <- pivot_longer(var_preco, cols = c(3:5), names_to = "resultado", values_to = "valor")

participacao_mg <- cbind(vbp_particip, ci_particip[3], vab_particip[3])
colnames(participacao_mg) <- c("setor", "ano", "VBP", "CI", "VAB")
participacao_mg <- pivot_longer(participacao_mg, cols = c(3:5), names_to = "resultado", values_to = "valor")

participacao_br <- cbind(vab_particip)
colnames(participacao_br) <- c("setor", "ano", "VAB")
participacao_br <- pivot_longer(participacao_br, cols = c(3), names_to = "resultado", values_to = "valor")


#função para exportação de imagens
export <- list(
    list(text="PNG",
         onclick=JS("function () {
                this.exportChartLocal(); }")),
    list(text="JPEG",
         onclick=JS("function () {
                this.exportChartLocal({ type: 'image/jpeg' }); }"))
    
)

#função auxiliar para criar gráfico de pizza
myhc_add_series_labels_values <- function (hc, labels, values, text, colors = NULL, ...) 
{
    assertthat::assert_that(is.highchart(hc), is.numeric(values), 
                            length(labels) == length(values))
    df <- dplyr::data_frame(name = labels, y = values, text=text)
    if (!is.null(colors)) {
        assert_that(length(labels) == length(colors))
        df <- mutate(df, color = colors)
    }
    ds <- list_parse(df)
    hc <- hc %>% hc_add_series(data = ds, ...)
    hc
}


areas <- c("Agropecuária", "Indústria",  "Serviços")
aspectos <- c("Valor Bruto da Produção (%)", "Consumo Intermediário (%)", "Valor Adicionado (%)")	

#função que mostra o logo carregando - não está funcionando
loadingLogo <- function(href, src, loadingsrc, height = NULL, width = NULL, alt = NULL) {
    tagList(
        tags$head(
            tags$script(
                "setInterval(function(){
                     if ($('html').attr('class')=='shiny-busy') {
                     $('div.busy').show();
                     $('div.notbusy').hide();
                     } else {
                     $('div.busy').hide();
                     $('div.notbusy').show();
           }
         },100)")
        ),
        tags$a(href=href,
               div(class = "busy",  
                   img(src=loadingsrc,height = height, width = width, alt = alt)),
               div(class = 'notbusy',
                   img(src = src, height = height, width = width, alt = alt))
        )
    )
}

# USER INTERFACE -------------------------------------------------------------------------------------
ui <- dashboardPage(
  
    #Título
    header <- dashboardHeader(title =  loadingLogo('http://fjp.mg.gov.br/',
                                                                     'logo_fjp.png',
                                                                     'loader.gif', 
                                                                     40,40)),
                              
                              
    #Barra lateral    
    dashboardSidebar(
        sidebarMenu( id = "barra_lateral",
            menuItem("Contas Econômicas", tabName = "contas_economicas"), 
            menuItem("PIB per capita", tabName = "pib_per_capita"),
            menuItem("Resultados", tabName = "resultados")
        ) 
        
  
        
    ),
            
    #Corpo    
    dashboardBody(
        #altera a cor do cabeçalho e coloca o título
        tags$head(tags$style(HTML(
            '.myClass { 
        font-size: 20px;
        line-height: 50px;
        text-align: left;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        padding: 0 15px;
        overflow: hidden;
        color: white;
        }
        '))),
          tags$script(HTML('
        $(document).ready(function() {
          $("header").find("nav").append(\'<span class="myClass"> PIB MG </span>\');
        })
       ')),
          
        tags$head(tags$style(HTML('
        /* logo */
        .skin-blue .main-header .logo {
                              background-color: #c3c3c3;
                              }
        /* logo when hovered */
        .skin-blue .main-header .logo:hover {
                              background-color: #c3c3c3;
                              }'))),
        
        tabItems(
            tabItem(tabName = 'contas_economicas',
                fluidRow( 
                  box(
                    title = "PIB segundo a ótica da Produção e da Renda", status = "primary", solidHeader = TRUE,
                    width = 10,
                    collapsible = FALSE,
                    box(
                      title = NULL, status = "success", solidHeader = FALSE, width = 12,
                      collapsible = FALSE,
                      fluidRow(box(highchartOutput('comp_prod_renda'), height=400,width = 12)),#,background='white')),
                      #box(
                      #  status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                      #  sliderInput("anos_lineplot_prod", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                      #)
                      
                    )
                  ),
                  box(
                    title = "Informações",  status = "primary", solidHeader = TRUE, width = 2
                  )
                  
                ),    
                fluidRow( 
                    box(
                        title = "Ótica da Produção", status = "primary", solidHeader = TRUE,
                        width = 10,
                        collapsible = FALSE,
                        box(
                            title = NULL, status = "success", solidHeader = FALSE, width = 6,
                            collapsible = FALSE,
                            fluidRow(box(highchartOutput('linePlot_prod'), height=400,width = 12)),#,background='white')),
                            box(
                                status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                sliderInput("anos_lineplot_prod", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                            )
                            
                        ),
                        box(
                            title = NULL, status = "success", solidHeader = FALSE, width = 6,
                            collapsible = FALSE,
                            fluidRow(box(highchartOutput('piePlot_prod'), height=400 ,width = 12)),#,background='white')),
                            box(
                                status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                sliderInput("anos_columplot_prod", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                            )
                        )
                    )
                ),
                fluidRow( 
                    box(
                        title = "Ótica da Renda", status = "primary", solidHeader = TRUE,
                        width = 10,
                        collapsible = FALSE,
                        box(
                            title = NULL, status = "success", solidHeader = FALSE,
                            collapsible = FALSE, width = 6,
                            fluidRow(box(highchartOutput('linePlot_renda'), height=400,width = 12)),#,background='white')),
                            box(
                                status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                sliderInput("anos_lineplot_renda", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                            )
                        ),
                        box(
                            title = NULL, status = "success", solidHeader = FALSE,
                            collapsible = FALSE, width = 6,
                            fluidRow(box(highchartOutput('piePlot_renda'), height=400 ,width = 12)),#,background='white')),
                            box(
                                status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                sliderInput("anos_columnplot_renda", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                            )
                        )
                    )
                )
            ),
            tabItem(tabName = 'pib_per_capita',
                fluidRow( 
                    tabBox(
                        title = NULL, width = 12,
                        id = "tab_opcoes_pib_per_capta", height = "250px",
                        tabPanel("Gráficos lado a lado", 
                           fluidRow( 
                             box(
                               title = "PIB", status = "primary", solidHeader = TRUE,
                               width = 4,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita4'), height=400,width = 12)),#,background='white')),
                               ),
                             ),
                             box(
                               title = "População", status = "primary", solidHeader = TRUE,
                               width = 4,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita5'), height=400,width = 12)),#,background='white')),
                               ),
                             ),
                             box(
                               title = "PIB per capita", status = "primary", solidHeader = TRUE,
                               width = 4,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita6'), height=400,width = 12)),#,background='white')),
                               )
                             ),
                             fluidRow(
                               box(
                                 status = "info", solidHeader = FALSE, width = 6, collapsed = FALSE, collapsible = FALSE,
                                 sliderInput("anos_lineplot_pib_percapita7", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                               ), 
                               box(
                                 status = "info", solidHeader = FALSE, width = 3, collapsed = FALSE, collapsible = FALSE,
                                 radioButtons(inputId = "tipo_graf_lineplot_pib_percapita", choices = c("Linha", "Barra"), label = "Escolha o tipo de gráfico:", inline = TRUE)
                               )
                             )
                           )
                        ),
                        tabPanel("Gráfico único",
                           fluidRow( 
                             box(
                               title = "PIB", status = "primary", solidHeader = TRUE,
                               width = 10,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita8'), height=400,width = 12)),#,background='white')),
                                 box(
                                   status = "info", solidHeader = FALSE, width = 12, collapsed = FALSE, collapsible = TRUE,
                                   sliderInput("anos_lineplot_pib_percapita8", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                                 )
                               ),
                             )
                           ),        
                        ),
                        tabPanel("Um gráfico por linha",
                           fluidRow( 
                             box(
                               title = "PIB", status = "primary", solidHeader = TRUE,
                               width = 10,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita1'), height=400,width = 12)),#,background='white')),
                                 box(
                                   status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                   radioButtons(inputId = "tipo_graf_lineplot_pib_percapita1",choices = c("Linha", "Barra"), label = NULL, inline = TRUE),
                                   sliderInput("anos_lineplot_pib_percapita1", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                                 )
                               ),
                             )
                           ), 
                           fluidRow( 
                             box(
                               title = "População", status = "primary", solidHeader = TRUE,
                               width = 10,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita2'), height=400,width = 12)),#,background='white')),
                                 box(
                                   status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                   radioButtons(inputId = "tipo_graf_lineplot_pib_percapita2",choices = c("Linha", "Barra"), label = NULL, inline = TRUE),
                                   sliderInput("anos_lineplot_pib_percapita2", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                                 )
                               ),
                             )
                           ),
                           fluidRow( 
                             box(
                               title = "PIB per capita", status = "primary", solidHeader = TRUE,
                               width = 10,
                               box(
                                 title = NULL, status = "success", solidHeader = FALSE, width = 12,
                                 collapsible = FALSE,
                                 fluidRow(box(highchartOutput('linePlot_pib_percapita3'), height=400,width = 12)),#,background='white')),
                                 box(
                                   status = "info", solidHeader = FALSE, width = 12, collapsed = TRUE, collapsible = TRUE,
                                   radioButtons(inputId = "tipo_graf_lineplot_pib_percapita3",choices = c("Linha", "Barra"), label = NULL, inline = TRUE),
                                   sliderInput("anos_lineplot_pib_percapita3", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T)
                                 )
                               ),
                             )
                           )     
                       ),
                       tabPanel("Informações",
                          fluidRow( 
                            box(
                              title = "PIB", status = "primary", solidHeader = TRUE,
                              width = 10,
                            )
                          )
                       )
                    )
                )
            ),
                    
            tabItem(tabName = 'resultados',
                    fluidRow( 
                        tabBox(
                            title = NULL, width = 12,
                            id = "tab_opcoes", height = "250px",
                            tabPanel("Opção 1", 
                                 fluidRow(
                                     box(
                                         status = "info", solidHeader = FALSE, width = 12, collapsible = FALSE,
                                         radioButtons(inputId = "tipo_resultado", label = "Escolha:", choices = tipoResutados, selected = "VBP", inline = TRUE)
                                     )
                                 ),
                                fluidRow(
                                    box(
                                        status = "warning", solidHeader = FALSE, width = 3, collapsible = FALSE,
                                        radioButtons(inputId = "area_ou_setor_aspecto_fixo", label = NULL, choices = c("Setores", "Áreas"), selected = "Setores", inline = TRUE),
                                        conditionalPanel(
                                            condition = "input.area_ou_setor_aspecto_fixo == 'Setores'",
                                            checkboxInput(inputId = "spec_setores_aspecto_fixo_tudo", label = "Selecionar Tudo", value = FALSE),
                                            checkboxGroupInput(inputId = "spec_setores_aspecto_fixo", label = NULL, choices = setor, selected = setor[1])
                                        ),
                                        conditionalPanel(
                                            condition = "input.area_ou_setor_aspecto_fixo == 'Áreas'", 
                                            checkboxGroupInput(inputId = "spec_areas_aspecto_fixo", label = NULL, choices = area, selected = area[1])
                                        )
                                    ),
                                    box(
                                        status = "warning", solidHeader = FALSE, width = 3, collapsible = FALSE,
                                        radioButtons(inputId = "aspectos_aspecto_fixo", label = NULL, choices = aspectos2, selected = aspectos2[1])
                                    ),
                                    box(
                                        status = "info", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                        fluidRow(box(highchartOutput('plot_vbp_ci_vab_aspecto_fixo'), height=400,width = 12)),#,background='white')),
                                        
                                    ),
                                ),
                                fluidRow(
                                    box(
                                        status = "warning", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                        radioButtons(inputId = "tipo_grafico_aspecto_fixo", label = "Tipo de gráfico", choices = tiposGraficos, selected = 'linha', inline = TRUE)
                                    ),
                                    box(
                                        status = "warning", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                        sliderInput("anos_resultados_aspecto_fixo", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T),
                                        sliderInput("anos_resultados_aspecto_fixo_pizza", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(ultimo_ano),animate=T)
                                    ),
                                    
                                )        
                            ),
                            tabPanel("Opção 2", 
                                     fluidRow(
                                         box(
                                             status = "info", solidHeader = FALSE, width = 12, collapsible = FALSE,
                                             radioButtons(inputId = "aspectos_setor_fixo", label = "Escolha:", choices = aspectos2, selected = aspectos2[1], inline = TRUE)
                                             
                                         )
                                     ),
                                     fluidRow(
                                         box(
                                             status = "warning", solidHeader = FALSE, width = 3, collapsible = FALSE,
                                             radioButtons(inputId = "area_ou_setor_setor_fixo", label = NULL, choices = c("Setores", "Áreas"), selected = "Setores", inline = TRUE),
                                             conditionalPanel(
                                                 condition = "input.area_ou_setor_setor_fixo == 'Setores'",
                                                 radioButtons(inputId = "spec_setores_setor_fixo", label = NULL, choices = setor, selected = setor[1])
                                             ),
                                             conditionalPanel(
                                                 condition = "input.area_ou_setor_setor_fixo == 'Áreas'", 
                                                 radioButtons(inputId = "spec_areas_setor_fixo", label = NULL, choices = area, selected = area[1])
                                             )
                                         ),
                                         box(
                                             status = "warning", solidHeader = FALSE, width = 3, collapsible = FALSE,
                                             checkboxGroupInput(inputId = "tipo_resultado_2", label = NULL, choices = tipoResutados, selected = c("VBP", "CI", "VAB"))
                                         ),
                                         box(
                                             status = "info", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                             fluidRow(box(highchartOutput('plot_vbp_ci_vab_setor_fixo'), height=400,width = 12)),#,background='white')),
                                             
                                         ),
                                     ),
                                     fluidRow(
                                         box(
                                             status = "warning", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                             radioButtons(inputId = "tipo_grafico_setor_fixo", label = "Tipo de gráfico", choices = tiposGraficos2, selected = 'linha', inline = TRUE)
                                         ),
                                         box(
                                             status = "warning", solidHeader = FALSE, width = 6, collapsible = FALSE,
                                             sliderInput("anos_resultados_setor_fixo", "Escolha o ano:", min=2010, max=ultimo_ano, value=c(2010, ultimo_ano),animate=T),
                                             
                                         ),
                                         
                                     )
                            )
                        )
                    )
            )
        )
       
    ),
      
               
    shinyjs::useShinyjs(),           
             
       
              
        
)



# Define server logic required to draw a histogram
server <- function(input, output, session) {

   
    #read_excel("H:\\FJP\\scripts\\Anexo-estatistico-PIB-MG-anual-2010-2018.xlsx")
    
   
    
    #desabilita a opção de Participação das atividades no VAB do Brasil caso VAB não seja selecionado
    observeEvent(input$tipo_resultado, {
        if(input$tipo_resultado == "VBP" || input$tipo_resultado == "CI"){
            shinyjs::disable(selector = "#aspectos_aspecto_fixo input[value='pbr']")
            if(input$aspectos_aspecto_fixo == 'pbr'){
                updateRadioButtons(inputId = "aspectos_aspecto_fixo", selected = aspectos2[4])
            }
        }
        else{
            shinyjs::enable(selector = "#aspectos_aspecto_fixo input[value='pbr']")
        }
    })
    
    #desabilita as opções VBP e CI quando partipação no Brasil é selecionado, opção 2
    observeEvent(input$aspectos_setor_fixo, {
        if(input$aspectos_setor_fixo == "pbr"){
            shinyjs::disable(selector = "#tipo_resultado_2 input[value='VBP']")
            shinyjs::disable(selector = "#tipo_resultado_2 input[value='CI']")
            if(input$tipo_resultado_2 == 'VBP' || input$tipo_resultado_2 == 'CI'){
                updateCheckboxGroupInput(inputId = "tipo_resultado_2", selected = tipoResutados[3])
            }
            
        }
        else{
            shinyjs::enable(selector = "#tipo_resultado_2 input[value='VBP']")
            shinyjs::enable(selector = "#tipo_resultado_2 input[value='CI']")
        }
    })
    
    #faz com que o tipo de gráfico selecionado seja o de linha quando o usuário selecionou o gráfico de barra empilhado ou pizza e escolheu um
    #aspecto que não comporta esse tipo de gráfico
    observeEvent(input$aspectos_aspecto_fixo, {
        if(input$aspectos_aspecto_fixo == "vv" || input$aspectos_aspecto_fixo == "vc" || input$aspectos_aspecto_fixo == "vp" || input$aspectos_aspecto_fixo == "pbr"){
            if(input$tipo_grafico_aspecto_fixo == 'barra_empilhado' || input$tipo_grafico_aspecto_fixo == 'pizza'){
                updateRadioButtons(inputId = "tipo_grafico_aspecto_fixo", selected = tiposGraficos[1])
            }
        }
        
    })
    
    #habilita as opções de gráfico barra empilhado e pizza quando o usuário seleciona participação em minas
    observeEvent(input$aspectos_aspecto_fixo, {
        if(input$aspectos_aspecto_fixo == "vc" || input$aspectos_aspecto_fixo == "vv" || input$aspectos_aspecto_fixo == "vp" || input$aspectos_aspecto_fixo == "pbr"){
            shinyjs::disable(selector = "#tipo_grafico_aspecto_fixo input[value= 'barra_empilhado']")
            shinyjs::disable(selector = "#tipo_grafico_aspecto_fixo input[value= 'pizza']")
        }
        else{
            shinyjs::enable(selector = "#tipo_grafico_aspecto_fixo input[value = 'barra_empilhado']")
            shinyjs::enable(selector = "#tipo_grafico_aspecto_fixo input[value = 'pizza']")
        }
    })
    
    #muda a opção de ano quando o usuário escolhe o gráfico de pizza
    observeEvent(input$tipo_grafico_aspecto_fixo, {
        if(input$tipo_grafico_aspecto_fixo == "pizza"){
            shinyjs::hide(id = "anos_resultados_aspecto_fixo")
            shinyjs::show(id = "anos_resultados_aspecto_fixo_pizza")
        }
        else{
            shinyjs::show(id = "anos_resultados_aspecto_fixo")
            shinyjs::hide(id = "anos_resultados_aspecto_fixo_pizza")
        }
    })

    
    #seleciona o primeiro setor quando o usuário desmarca a opção de selecionar todos
    observe({
        updateCheckboxGroupInput(
            session, 'spec_setores_aspecto_fixo', choices = setor,
            selected = {if(input$spec_setores_aspecto_fixo_tudo) setor
                        else setor[1]} 
        )
    })
   
    output$titulo1<-renderText("Ótica da Produção")
    output$titulo2<-renderText("Ótica da Renda")
    output$linePlot_prod <- renderHighchart({
        if(input$barra_lateral == 'contas_economicas'){
            
                #Contas é uma coluna da tabela contas_economicas
              
            h <- highchart() %>% 
                hc_size(width = 600, height = 400) %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE) %>%
                hc_exporting(enabled = T, fallbackToExportServer = F, 
                             menuItems = export)   
          
                
                ds <- lapply(espec_prod, function(x){
                    d <- subset(contas_economicas, contas %in% x & (ano >= input$anos_lineplot_prod[1] & ano <= input$anos_lineplot_prod[2]))
                    data = data.frame(x = d$ano,
                                      y = d$valor)
                })   
                
                
                h <- h %>% hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) "))  %>%
                    hc_title(text = list("Contas da Econômicas - ótica da produção"))
            
            for (k in 1:length(ds)) {
                h <- h %>%
                    hc_add_series(ds[[k]], name = espec_prod[k])
            }
            h 
           
        }
            
        
    })
    
    output$comp_prod_renda <- renderHighchart({
      if(input$barra_lateral == 'contas_economicas'){
        h <-highchart() %>% 
          hc_chart(type = "column") %>%
          hc_plotOptions(column = list(stacking = "normal")) %>%
          hc_xAxis(categories = c(input$anos_columplot_prod[1] : input$anos_columplot_prod[2]), title = list(text = "Ano")) %>%
          hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
          hc_title(text = list("Composição do PIB - ótica da produção")) %>%
          hc_add_series(name= nomes_producao[1],
                        data = subset(contas_economicas, contas %in% nomes_producao[1] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                        stack = "Produção", color = '#800000') %>%
          hc_add_series(name=nomes_producao[2],
                        data = subset(contas_economicas, contas %in% nomes_producao[2] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                        stack = "Produção", color = '#FF0000') %>%
          hc_add_series(name=nomes_producao[3],
                        data = subset(contas_economicas, contas %in% nomes_producao[3] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                        stack = "PIB_prod", color = '#CD5C5C') %>%
          hc_add_series(name= "PIB produção",
                        data = subset(contas_economicas, contas %in% nomes_producao[4] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                        stack = "PIB_prod", color = '#FA8072') %>%
          hc_add_series(name="PIB renda",
                        data = subset(contas_economicas, contas %in% nomes_renda[6] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                        stack = "PIB_renda", color = '#8A2BE2' ) %>%
          hc_add_series(name= nomes_renda[2],
                        data = subset(contas_economicas, contas %in% nomes_renda[2] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                        stack = "Salarios", color = '#000080') %>%
          hc_add_series(name= nomes_renda[3],
                        data = subset(contas_economicas, contas %in% nomes_renda[3] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                        stack = "Salarios", color = '#0000FF') %>%
          hc_add_series(name=nomes_renda[4],
                        data = subset(contas_economicas, contas %in% nomes_renda[4] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                        stack = "Salarios", color = '#7B68EE') %>%
          hc_add_series(name=nomes_renda[5],
                        data = subset(contas_economicas, contas %in% nomes_renda[5] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                        stack = "Salarios", color = '#00BFFF') %>%
          hc_tooltip(crosshairs = TRUE, formatter= JS(paste0 ('function () {
                  var string = "";
                  if(this.series.name == "Produção" || this.series.name == "Impostos produtos" || this.series.name == "Consumo Intermediário" || this.series.name == "PIB produção"){
                    string += "<br>Ótica da produção </br>";
                  } 
                  else if(this.series.name == "PIB renda" || this.series.name == "Salários" || this.series.name == "Contribuições" || this.series.name == "Impostos produção" || this.series.name == "Excedente"){
                    string += "<br>Ótica da renda </br>";
                  } 
                  string += this.series.name + ": <b>" + Highcharts.numberFormat(this.y, 1) + " mi R$ </b> em " + this.x
                  
                  return string;
                }'))) %>%
          hc_exporting(
            enabled = TRUE, # always enabled
            filename = "custom-file-name"
          )
        #hc_add_theme(hc_theme_ft())
        h
        
      }
    })
    
    output$piePlot_prod <- renderHighchart({
        if(input$barra_lateral == 'contas_economicas'){
            h <-highchart() %>% 
                hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_columplot_prod[1] : input$anos_columplot_prod[2]), title = list(text = "Ano")) %>%
                hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
                hc_title(text = list("Composição do PIB - ótica da produção")) %>%
                hc_add_series(name= nomes_producao[1],
                              data = subset(contas_economicas, contas %in% nomes_producao[1] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name=nomes_producao[2],
                              data = subset(contas_economicas, contas %in% nomes_producao[2] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name=nomes_producao[3],
                              data = subset(contas_economicas, contas %in% nomes_producao[3] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                              stack = "Consumo") %>%
                hc_add_series(name=nomes_producao[4],
                              data = subset(contas_economicas, contas %in% nomes_producao[4] & (ano >= input$anos_columplot_prod[1] & ano <= input$anos_columplot_prod[2]))$valor,
                              stack = "Consumo") %>%
                hc_exporting(
                    enabled = TRUE, # always enabled
                    filename = "custom-file-name"
                )
                #hc_add_theme(hc_theme_ft())
            h
            
        }
    })
    
    output$linePlot_renda <- renderHighchart({
        if(input$barra_lateral == 'contas_economicas'){
            
              ds <- lapply(espec_renda, function(x){
                  d <- subset(contas_economicas, contas %in% x & (ano >= input$anos_lineplot_renda[1] & ano <= input$anos_lineplot_renda[2]))
                  data = data.frame(x = d$ano,
                                    y = d$valor)
                  
                  
              })
              
              h <- highchart() %>% 
                  hc_size(width = 600, height = 400) %>%
                  hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
                  hc_title(text = list("Contas da Econômicas - ótica da renda")) %>%
                  hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE) %>%
                  hc_exporting(enabled = T, fallbackToExportServer = F, 
                               menuItems = export)   
              for (k in 1:length(ds)) {
                  h <- h %>%
                      hc_add_series(ds[[k]], name = espec_renda[k])
              }
              h
            
        }
    })
    output$piePlot_renda <- renderHighchart({
        if(input$barra_lateral == 'contas_economicas'){
            h <-highchart() %>% 
                hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_columnplot_renda[1] : input$anos_columnplot_renda[2]), title = list(text = "Ano")) %>%
                hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
                hc_title(text = list("Composição - ótica da renda")) %>%
                hc_add_series(name= nomes_renda[2],
                              data = subset(contas_economicas, contas %in% nomes_renda[2] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name= nomes_renda[3],
                              data = subset(contas_economicas, contas %in% nomes_renda[3] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name=nomes_renda[4],
                              data = subset(contas_economicas, contas %in% nomes_renda[4] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name=nomes_renda[5],
                              data = subset(contas_economicas, contas %in% nomes_renda[5] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                              stack = "Produção") %>%
                hc_add_series(name=nomes_renda[6],
                              data = subset(contas_economicas, contas %in% nomes_renda[6] & (ano >= input$anos_columnplot_renda[1] & ano <= input$anos_columnplot_renda[2]))$valor,
                              stack = "Valor adicionado") %>%
                
                hc_exporting(
                    enabled = TRUE, # always enabled
                    filename = "custom-file-name"
                )
            #hc_add_theme(hc_theme_ft())
            h
            
        }
    })
    
    ## PIB per capita --------------------------------------------------------------------------------
    
    output$linePlot_pib_percapita1 <- renderHighchart({
       
        ds <- lapply(c("PIB"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita1[1] & ano <= input$anos_lineplot_pib_percapita1[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })

        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
            hc_title(text = list("PIB")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        if(input$tipo_graf_lineplot_pib_percapita1 == "Linha"){
            h <- h %>%
            hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
            hc_plotOptions(column = list(stacking = "normal")) %>%
            hc_xAxis(categories = c(input$anos_lineplot_pib_percapita1[1] : input$anos_lineplot_pib_percapita1[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('PIB'))
        
        h
            
        
    })
    
    output$linePlot_pib_percapita2 <- renderHighchart({
        ds <- lapply(c("População"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita2[1] & ano <= input$anos_lineplot_pib_percapita2[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "População residente (1000 hab) ")) %>%
            hc_title(text = list("População")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                     menuItems = export) 
           
        
        if(input$tipo_graf_lineplot_pib_percapita2 == "Linha"){
            h <- h %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_lineplot_pib_percapita2[1] : input$anos_lineplot_pib_percapita2[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('População'))
        
          h
    })
    
    output$linePlot_pib_percapita3 <- renderHighchart({

        ds <- lapply(c("PIB per capita"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita3[1] & ano <= input$anos_lineplot_pib_percapita3[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "Valor a preços correntes (R$) ")) %>%
            hc_title(text = list("PIB per capita")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        
        
        if(input$tipo_graf_lineplot_pib_percapita3 == "Linha"){
            h <- h %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_lineplot_pib_percapita3[1] : input$anos_lineplot_pib_percapita3[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('PIB per capita'))
        
        h
          
        
    })
    
    output$linePlot_pib_percapita4 <- renderHighchart({
      
        ds <- lapply(c("PIB"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita7[1] & ano <= input$anos_lineplot_pib_percapita7[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "Valor a preços correntes (1.000.000 R$) ")) %>%
            hc_title(text = list("PIB")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        if(input$tipo_graf_lineplot_pib_percapita == "Linha"){
            h <- h %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_lineplot_pib_percapita7[1] : input$anos_lineplot_pib_percapita7[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('PIB'))
        
        h
            
        
    })
    
    output$linePlot_pib_percapita5 <- renderHighchart({
        
        ds <- lapply(c("População"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita7[1] & ano <= input$anos_lineplot_pib_percapita7[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "População residente (1000 hab) ")) %>%
            hc_title(text = list("População")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        
        
        if(input$tipo_graf_lineplot_pib_percapita == "Linha"){
            h <- h %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_lineplot_pib_percapita7[1] : input$anos_lineplot_pib_percapita7[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('População'))
        
        h
            
        
    })
    
    output$linePlot_pib_percapita6 <- renderHighchart({
        
        ds <- lapply(c("PIB per capita"), function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita7[1] & ano <= input$anos_lineplot_pib_percapita7[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        h <- highchart() %>% 
            #hc_size(width = 600, height = 400) %>%
            hc_yAxis(title = list(text = "Valor a preços correntes (R$) ")) %>%
            hc_title(text = list("PIB per capita")) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        
        
        if(input$tipo_graf_lineplot_pib_percapita == "Linha"){
            h <- h %>%
                hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        }
        else{
            h <- h %>% hc_chart(type = "column") %>%
                hc_plotOptions(column = list(stacking = "normal")) %>%
                hc_xAxis(categories = c(input$anos_lineplot_pib_percapita7[1] : input$anos_lineplot_pib_percapita7[2]), title = list(text = "Ano"))
        }
        h <- h %>% hc_add_series(ds[[1]], name = c('PIB per capita'))
        
        h
            
        
    })
    
    output$linePlot_pib_percapita8 <- renderHighchart({
        
        espec <- c("PIB","PIB per capita", "População")
        ds <- lapply(espec, function(x){
            d <- subset(pib_percapita, especificacao %in% x & (ano >= input$anos_lineplot_pib_percapita8[1] & ano <= input$anos_lineplot_pib_percapita8[2]))
            data = data.frame(x = d$ano,
                              y = d$valor)
            
        })
        
        hc <- highchart()%>%
            hc_xAxis(categories = c(2010: ultimo_ano), title = list(text = "Ano")) %>%
            hc_yAxis_multiples(list(title = list(text = "PIB (1000000 R$)"), opposite = FALSE, showEmpty= FALSE),
                               list(title = list(text = "PIB per capita (R$)"),opposite = FALSE, showEmpty= FALSE),
                               list(title = list(text = "População"), opposite = TRUE, showEmpty= FALSE )) %>%
            hc_plotOptions(column = list(stacking = "normal")) %>%
            hc_add_series(ds[[3]],type="column", name=espec[3], yAxis=2) %>%
            hc_add_series(ds[[1]],type="line", name=espec[1], yAxis=0) %>%
            hc_add_series(ds[[2]],type="line", name=espec[2], yAxis=1) %>%
            hc_tooltip(crosshairs = TRUE,
                       borderWidth = 5,
                       sort = FALSE,
                       table = TRUE) %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, 
                         menuItems = export) 
        hc
        
    })
    
## Resultados -----------------------------------------------------------------------------    
   
    
    
    
    output$plot_vbp_ci_vab_aspecto_fixo <- renderHighchart({
        
        anos <- c(input$anos_resultados_aspecto_fixo[1], input$anos_resultados_aspecto_fixo[2])
        
        h <- highchart() %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, menuItems = export) %>%
            hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        
        if(input$tipo_resultado == 'VBP'){
            
            h <- h %>%
                hc_title(text = list("Valor Bruto da Produção - MG")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_aspecto_fixo == "barra" || input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_aspecto_fixo == "Setores"){
                if(!is_empty(input$spec_setores_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)")) 
                    }
                    else if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)")) %>%
                        hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    else if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)")) %>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    else if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        })
                        
                        
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Valor Bruto da Produção (%)")) %>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    
                    if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                        ds2 <- subset(vbp[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_setores_aspecto_fixo) & !(setor %in% c("Agropecuária", "Indústria", "Serviços")))
                        ds2 <- ds2 %>% 
                            group_by(ano) %>% 
                            summarise(particip = sum(particip)) 
                        names(ds2) <- c('x', 'y')
                        
                            
                        for (k in 1:length(ds)) {
                            h <- h %>%  
                            hc_add_series(data = ds[[k]], name = input$spec_setores_aspecto_fixo[k], stack = "Valor") #, dataLabels = list(enabled = TRUE,
                                                                                                                       #                 format = '{point.name}: {point.percentage:.1f} %'))
                        }
                            h <- h %>%hc_plotOptions(column = list(stacking = "normal"))
                            
                                
                        if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                            h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                            
                        }
                      
                           
                        
                            
                    }
                    else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                        
                        ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                        
                        if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                            d <- subset(vbp[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                            demais <- sum(d$particip )
                            labels_pi_chart <- c(input$spec_setores_aspecto_fixo, "Outros")
                            valores_pi_chart <- c(subset(vbp[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                        }
                        else{
                            d <- subset(vbp[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                            labels_pi_chart <- c(input$spec_setores_aspecto_fixo)
                            valores_pi_chart <- c(subset(vbp[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                        }
                        
                        
                        h <- h %>% 
                            hc_chart(type = "pie") %>% 
                            hc_subtitle(text = (paste("Part. das atividades no Valor Bruto da Produção - ", toString(ano_pie_chart)))) %>%
                            myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                          dataLabels = list(enabled = TRUE,
                                                                            format = '{point.name}: {point.percentage:.1f} %'))%>%
                            hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                            
                    }
                    else{
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_setores_aspecto_fixo[k])
                                
                            
                            
                        } 
                    }
                    
                    
                }
                
            }
            else{
                if(!is_empty(input$spec_areas_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)")) %>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
                        
                        
                    }
                    if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vbp, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Valor Bruto da Produção (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                        
                    }
                        
                    if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                        ds2 <- subset(vbp[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_areas_aspecto_fixo) & (setor %in% c("Agropecuária", "Indústria", "Serviços")))
                        ds2 <- ds2 %>% 
                            group_by(ano) %>% 
                            summarise(particip = sum(particip)) 
                        names(ds2) <- c('x', 'y')
                        
                        
                        for (k in 1:length(ds)) {
                            h <- h %>%    
                                hc_add_series(data = ds[[k]], name = input$spec_areas_aspecto_fixo[k], stack = "Valor")
                        }
                        h <- h %>%hc_plotOptions(column = list(stacking = "normal"))
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                        }
                            
                    }
                    else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                        
                        ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            d <- subset(vbp[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            demais <- sum(d$particip )
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo, "Outros")
                            valores_pi_chart <- c(subset(vbp[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                        }
                        else{
                            d <- subset(vbp[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo)
                            valores_pi_chart <- c(subset(vbp[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                        }
                        
                        h <- h %>% 
                            hc_chart(type = "pie") %>% 
                            hc_subtitle(text = (paste("Part. das atividades no Valor Bruto da Produção - ", toString(ano_pie_chart)))) %>%
                            myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                          dataLabels = list(enabled = TRUE,
                                                                            format = '{point.name}: {point.percentage:.1f} %'))%>%
                            hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                                                          
                    }
                    else{
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_areas_aspecto_fixo[k])
                            
                        }
                    }
                    
                }
            }
            
            h 
            
                
        }
        else if(input$tipo_resultado == 'CI'){
            
            
            h <- h %>%
                hc_title(text = list("Consumo Intermediário - MG")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_aspecto_fixo == "barra" || input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_aspecto_fixo == "Setores"){
                if(!is_empty(input$spec_setores_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)"))
                    }
                    else if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    else if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    else if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        })
                        
                        
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Consumo Intermediário (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    
                    if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                        ds2 <- subset(ci[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_setores_aspecto_fixo) & !(setor %in% c("Agropecuária", "Indústria", "Serviços")))
                        ds2 <- ds2 %>% 
                            group_by(ano) %>% 
                            summarise(particip = sum(particip)) 
                        names(ds2) <- c('x', 'y')
                        
                        
                        for (k in 1:length(ds)) {
                            h <- h %>%  
                                hc_add_series(data = ds[[k]], name = input$spec_setores_aspecto_fixo[k], stack = "Valor") #, dataLabels = list(enabled = TRUE,
                            #                 format = '{point.name}: {point.percentage:.1f} %'))
                        }
                        h <- h %>%hc_plotOptions(column = list(stacking = "normal"))
                        
                        if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                            h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                            
                        }
                        
                        
                        
                        
                    }
                    else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                        
                        ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                        
                        if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                            d <- subset(ci[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                            demais <- sum(d$particip )
                            labels_pi_chart <- c(input$spec_setores_aspecto_fixo, "Outros")
                            valores_pi_chart <- c(subset(ci[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                        }
                        else{
                            d <- subset(ci[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                            labels_pi_chart <- c(input$spec_setores_aspecto_fixo)
                            valores_pi_chart <- c(subset(ci[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                        }
                        
                        
                        h <- h %>% 
                            hc_chart(type = "pie") %>% 
                            hc_subtitle(text = (paste("Part. das atividades no Consumo Intermediário - ", toString(ano_pie_chart)))) %>%
                            myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                          dataLabels = list(enabled = TRUE,
                                                                            format = '{point.name}: {point.percentage:.1f} %'))%>%
                                                hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                        
                    }
                    else{
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_setores_aspecto_fixo[k])
                            
                        } 
                    }
                    
                    
                }
                
            }
            else{
                if(!is_empty(input$spec_areas_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
                        
                        
                    }
                    if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(ci, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Consumo Intermediário (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    
                    if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                        ds2 <- subset(ci[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_areas_aspecto_fixo) & (setor %in% c("Agropecuária", "Indústria", "Serviços")))
                        ds2 <- ds2 %>% 
                            group_by(ano) %>% 
                            summarise(particip = sum(particip)) 
                        names(ds2) <- c('x', 'y')
                        
                        
                        for (k in 1:length(ds)) {
                            h <- h %>%    
                                hc_add_series(data = ds[[k]], name = input$spec_areas_aspecto_fixo[k], stack = "Valor")
                        }
                        h <- h %>%hc_plotOptions(column = list(stacking = "normal"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                        }
                        
                    }
                    else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                        
                        ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            d <- subset(ci[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            demais <- sum(d$particip )
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo, "Outros")
                            valores_pi_chart <- c(subset(ci[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                        }
                        else{
                            d <- subset(ci[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo)
                            valores_pi_chart <- c(subset(ci[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                        }
                        
                        h <- h %>% 
                            hc_chart(type = "pie") %>% 
                            hc_subtitle(text = (paste("Part. das atividades no Consumo Intermediário - ", toString(ano_pie_chart)))) %>%
                            myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                          dataLabels = list(enabled = TRUE,
                                                                            format = '{point.name}: {point.percentage:.1f} %'))%>%
                            hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                        
                        
                    }
                    else{
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_areas_aspecto_fixo[k])
                            
                        }
                    }
                    
                }
            }
            h 
            
            
        }
        else if(input$tipo_resultado == 'VAB'){
            
            
            h <- h %>%
                hc_title(text = list("Valor Adicionado Bruto - MG")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} % <br>")
            if(input$tipo_grafico_aspecto_fixo == "barra" || input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_aspecto_fixo == "Setores"){
                if(!is_empty(input$spec_setores_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
                    }
                    if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        })
                        
                        
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Valor Adicionado Bruto (%)"))
                        
                        if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                            ds2 <- subset(vab[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_setores_aspecto_fixo) & !(setor %in% c("Agropecuária", "Indústria", "Serviços")))
                            ds2 <- ds2 %>% 
                                group_by(ano) %>% 
                                summarise(particip = sum(particip)) 
                            names(ds2) <- c('x', 'y')
                            
                            
                            for (k in 1:length(ds)) {
                                h <- h %>%  
                                    hc_add_series(data = ds[[k]], name = input$spec_setores_aspecto_fixo[k], stack = "Valor") #, dataLabels = list(enabled = TRUE,
                                #                 format = '{point.name}: {point.percentage:.1f} %'))
                            }
                            h <- h %>%hc_plotOptions(column = list(stacking = "normal"))%>%
                                hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                            
                            if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                                h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                                
                            }
                            
                            
                            
                            
                        }
                        else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                            
                            ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                            
                            if(!setequal(input$spec_setores_aspecto_fixo, setor)){ #verifica se todas as opções estão selecionadas
                                d <- subset(vab[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                                demais <- sum(d$particip )
                                labels_pi_chart <- c(input$spec_setores_aspecto_fixo, "Outros")
                                valores_pi_chart <- c(subset(vab[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                            }
                            else{
                                d <- subset(vab[c(1,2, 6)], !(setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_setores_aspecto_fixo))
                                labels_pi_chart <- c(input$spec_setores_aspecto_fixo)
                                valores_pi_chart <- c(subset(vab[c(1, 2, 6)], setor %in% input$spec_setores_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                            }
                            
                            
                            h <- h %>% 
                                hc_chart(type = "pie") %>% 
                                hc_subtitle(text = (paste("Part. das atividades no Consumo Intermediário - ", toString(ano_pie_chart)))) %>%
                                myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                              dataLabels = list(enabled = TRUE,
                                                                                format = '{point.name}: {point.percentage:.1f} %'))%>%
                                hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                            
                        }
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pbr"){
                        ds <- lapply(input$spec_setores_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip_br)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Participação no Valor Adicionado Bruto do Brasil (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                        
                    }
                    
                    if(!(input$tipo_grafico_aspecto_fixo == "barra_empilhado") && !(input$tipo_grafico_aspecto_fixo == "pizza")){
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_setores_aspecto_fixo[k])
                        }
                    }
                }
            }
            else{
                if(!is_empty(input$spec_areas_aspecto_fixo)){
                    if(input$aspectos_aspecto_fixo == 'vc'){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$corrente)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
                        
                        
                    }
                    if(input$aspectos_aspecto_fixo == "vv"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_volume)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Variação em volume (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                    }
                    if(input$aspectos_aspecto_fixo == "vp"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= 2011 & ano <= ultimo_ano))
                            data = data.frame(x = d$ano,
                                              y = d$var_preco)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Variação de preço (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pmg"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip)
                            
                        }) 
                        h <- h %>% hc_yAxis(title = list(text = "Part. das atividades no Valor Adicionado Bruto (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                    }
                    
                    if(input$tipo_grafico_aspecto_fixo == "barra_empilhado"){
                        ds2 <- subset(vab[c(1,2, 6)], (ano >= anos[1] & ano <= anos[2]) & !(setor %in% input$spec_areas_aspecto_fixo) & (setor %in% c("Agropecuária", "Indústria", "Serviços")))
                        ds2 <- ds2 %>% 
                            group_by(ano) %>% 
                            summarise(particip = sum(particip)) 
                        names(ds2) <- c('x', 'y')
                        
                        
                        for (k in 1:length(ds)) {
                            h <- h %>%    
                                hc_add_series(data = ds[[k]], name = input$spec_areas_aspecto_fixo[k], stack = "Valor")
                        }
                        h <- h %>%hc_plotOptions(column = list(stacking = "normal"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            h <- h %>% hc_add_series(data = ds2, name = "Outros", stack = "Valor")
                        }
                        
                    }
                    else if(input$tipo_grafico_aspecto_fixo == "pizza"){
                        
                        ano_pie_chart <-  input$anos_resultados_aspecto_fixo_pizza
                        
                        if(!setequal(input$spec_areas_aspecto_fixo, area)){ #verifica se todas as opções estão selecionadas
                            d <- subset(vab[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            demais <- sum(d$particip )
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo, "Outros")
                            valores_pi_chart <- c(subset(vab[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip, demais)
                        }
                        else{
                            d <- subset(vab[c(1,2, 6)], (setor %in% c("Agropecuária", "Indústria", "Serviços")) & ano %in% ano_pie_chart & !(setor %in% input$spec_areas_aspecto_fixo))
                            labels_pi_chart <- c(input$spec_areas_aspecto_fixo)
                            valores_pi_chart <- c(subset(vab[c(1, 2, 6)], setor %in% input$spec_areas_aspecto_fixo & ano %in% ano_pie_chart)$particip)
                        }
                        
                        h <- h %>% 
                            hc_chart(type = "pie") %>% 
                            hc_subtitle(text = (paste("Part. das atividades no Valor Adicionado Bruto - ", toString(ano_pie_chart)))) %>%
                            myhc_add_series_labels_values(labels = labels_pi_chart, values = valores_pi_chart, text = labels_pi_chart, 
                                                          dataLabels = list(enabled = TRUE,
                                                                            format = '{point.name}: {point.percentage:.1f} %'))%>%
                            hc_tooltip(pointFormat = "{point.name}: {point.y:.1f} % <br>")
                        
                    }
                    if(input$aspectos_aspecto_fixo == "pbr"){
                        ds <- lapply(input$spec_areas_aspecto_fixo, function(x){
                            d <- subset(vab, setor %in% x & (ano >= anos[1] & ano <= anos[2]))
                            data = data.frame(x = d$ano,
                                              y = d$particip_br)
                            
                        })
                        h <- h %>% hc_yAxis(title = list(text = "Participação no Valor Adicionado Bruto do Brasil (%)"))%>%
                            hc_tooltip(pointFormat = "{series.name}: {point.y:.1f} % <br>")
                        
                        
                    }
                    
                    if(!(input$tipo_grafico_aspecto_fixo == "barra_empilhado") && !(input$tipo_grafico_aspecto_fixo == "pizza")){
                        for (k in 1:length(ds)) {
                            h <- h %>%
                                hc_add_series(ds[[k]], name = input$spec_areas_aspecto_fixo[k])
                        }
                    }
                    
                    
                }
            }
            h 
            
            
            
        }
    })
    
    output$plot_vbp_ci_vab_setor_fixo <- renderHighchart({
        
        anos <- c(input$anos_resultados_setor_fixo[1], input$anos_resultados_setor_fixo[2])
        
        h <- highchart() %>%
            hc_exporting(enabled = T, fallbackToExportServer = F, menuItems = export) %>%
            hc_xAxis(title = list(text = "Ano"), allowDecimals = FALSE)
        
        if(input$aspectos_setor_fixo == 'vc'){
            
            h <- h %>%
                hc_title(text = list("Valor Corrente - MG")) %>%
                hc_yAxis(title = list(text = "Valor corrente (1.000.000 R$)")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_setor_fixo == "barra"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_setor_fixo == "Setores"){
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(valor_corrente, setor %in% input$spec_setores_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                    } 
                    h <- h %>% hc_subtitle(text = input$spec_setores_setor_fixo)
                }
            }
            else{
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(valor_corrente, setor %in% input$spec_areas_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                        
                    }
                    h <- h %>% hc_subtitle(text = input$spec_areas_setor_fixo)
                    
                }
            }
            
            h
        }
        else if(input$aspectos_setor_fixo == 'vv'){
            
            h <- h %>%
                hc_title(text = list("Variação de Volume - MG")) %>%
                hc_yAxis(title = list(text = "Variação Volume (%)")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_setor_fixo == "barra"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_setor_fixo == "Setores"){
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(var_volume, setor %in% input$spec_setores_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                    } 
                    h <- h %>% hc_subtitle(text = input$spec_setores_setor_fixo)
                }
            }
            else{
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(var_volume, setor %in% input$spec_areas_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                        
                    }
                    h <- h %>% hc_subtitle(text = input$spec_areas_setor_fixo)
                    
                }
            }
            
            h 
        }
        else if(input$aspectos_setor_fixo == 'vp'){
            
            h <- h %>%
                hc_title(text = list("Variação de Preço - MG")) %>%
                hc_yAxis(title = list(text = "Variação Preço (%)")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_setor_fixo == "barra"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_setor_fixo == "Setores"){
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(var_preco, setor %in% input$spec_setores_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                    } 
                    h <- h %>% hc_subtitle(text = input$spec_setores_setor_fixo)
                }
            }
            else{
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(var_preco, setor %in% input$spec_areas_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                        
                    }
                    h <- h %>% hc_subtitle(text = input$spec_areas_setor_fixo)
                    
                }
            }
            
            h 
            
            
        }
        else if(input$aspectos_setor_fixo == 'pmg'){
            
            h <- h %>%
                hc_title(text = list("Participação do Valor Corrente - MG")) %>%
                hc_yAxis(title = list(text = "Participação (%)")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_setor_fixo == "barra"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_setor_fixo == "Setores"){
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(participacao_mg, setor %in% input$spec_setores_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                    } 
                    h <- h %>% hc_subtitle(text = input$spec_setores_setor_fixo)
                }
            }
            else{
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(participacao_mg, setor %in% input$spec_areas_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                        
                    }
                    h <- h %>% hc_subtitle(text = input$spec_areas_setor_fixo)
                    
                }
            }
            
            h 
            
            
        }
        else if(input$aspectos_setor_fixo == 'pbr'){
            
            h <- h %>%
                hc_title(text = list("Participação do Valor Corrente - Brasil")) %>%
                hc_yAxis(title = list(text = "Participação (%)")) %>%
                hc_tooltip(crosshairs = TRUE,
                           borderWidth = 5,
                           sort = FALSE,
                           table = TRUE, 
                           headerFormat = 'Ano: {point.x}<br>',
                           pointFormat = "{series.name}: {point.y:.1f} mi R$ <br>")
            
            if(input$tipo_grafico_setor_fixo == "barra"){
                h <- h %>% hc_chart(type = "column")
            }
            
            if(input$area_ou_setor_setor_fixo == "Setores"){
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(participacao_br, setor %in% input$spec_setores_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                    } 
                    h <- h %>% hc_subtitle(text = input$spec_setores_setor_fixo)
                }
            }
            else{
                if(!is_empty(input$tipo_resultado_2)){
                    ds <- lapply(input$tipo_resultado_2, function(x){
                        d <- subset(participacao_br, setor %in% input$spec_areas_setor_fixo & resultado %in% x & (ano >= anos[1] & ano <= anos[2]))
                        data = data.frame(x = d$ano,
                                          y = d$valor)
                        
                    })
                    for (k in 1:length(ds)) {
                        h <- h %>%
                            hc_add_series(ds[[k]], name = input$tipo_resultado_2[k])
                        
                    }
                    h <- h %>% hc_subtitle(text = input$spec_areas_setor_fixo)
                    
                }
            }
            
            h 
            
            
        }
        
    })
    
    
}

# Run the application 
shinyApp(ui = ui, server = server)
